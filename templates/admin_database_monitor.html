{% extends "base.html" %}

{% block title %}Database Monitor - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-database"></i> Database Monitor</h2>
                <div>
                    <button class="btn btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Database Status Alert -->
            <div class="alert alert-{{ status_color }} alert-dismissible fade show" role="alert">
                <h4 class="alert-heading">
                    <i class="fas fa-{% if status == 'CRITICAL' %}exclamation-triangle{% elif status == 'WARNING' %}exclamation-circle{% else %}check-circle{% endif %}"></i>
                    Database Status: {{ status }}
                </h4>
                <p class="mb-0">
                    Current usage: <strong>{{ "%.2f"|format(usage_percentage) }}%</strong> 
                    ({{ db_size }})
                    {% if status == 'CRITICAL' %}
                        <br><strong>⚠️ CRITICAL:</strong> Database is nearly full! Consider cleanup or upgrade.
                    {% elif status == 'WARNING' %}
                        <br><strong>⚠️ WARNING:</strong> Database usage is high. Monitor closely.
                    {% else %}
                        <br><strong>✅ HEALTHY:</strong> Database usage is within normal limits.
                    {% endif %}
                </p>
            </div>

            <!-- Real-time Status Card -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Database Size</h6>
                                    <h4 id="db-size">{{ db_size }}</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-database fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Usage</h6>
                                    <h4 id="usage-percentage">{{ "%.1f"|format(usage_percentage) }}%</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-chart-pie fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Users</h6>
                                    <h4 id="user-count">{{ user_count }}</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Connections</h6>
                                    <h4 id="connection-count">{{ connection_info[0] if connection_info else 0 }}</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-plug fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usage Progress Bar -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Database Usage</h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar 
                            {% if usage_percentage >= 90 %}bg-danger
                            {% elif usage_percentage >= 75 %}bg-warning
                            {% elif usage_percentage >= 50 %}bg-info
                            {% else %}bg-success{% endif %}" 
                            role="progressbar" 
                            style="width: {{ usage_percentage }}%"
                            aria-valuenow="{{ usage_percentage }}" 
                            aria-valuemin="0" 
                            aria-valuemax="100">
                            {{ "%.1f"|format(usage_percentage) }}%
                        </div>
                    </div>
                    <small class="text-muted">
                        Max Size: {{ max_db_size_mb }} MB | 
                        Used: {{ db_size }} | 
                        Free: {{ "%.2f"|format((max_db_size_mb - (db_size_bytes / (1024*1024)))) }} MB
                    </small>
                </div>
            </div>

            <!-- Table Sizes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-table"></i> Table Sizes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Table Name</th>
                                    <th>Size</th>
                                    <th>Rows</th>
                                    <th>Usage %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for table in table_sizes %}
                                <tr>
                                    <td><code>{{ table[1] }}</code></td>
                                    <td>{{ table[2] }}</td>
                                    <td>{{ table[4] if table[4] else 'N/A' }}</td>
                                    <td>
                                        <div class="progress" style="height: 15px;">
                                            <div class="progress-bar bg-info" 
                                                 style="width: {{ (table[3] / db_size_bytes * 100) if db_size_bytes > 0 else 0 }}%">
                                                {{ "%.1f"|format((table[3] / db_size_bytes * 100) if db_size_bytes > 0 else 0) }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Connection Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-network-wired"></i> Connection Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-primary">{{ connection_info[0] if connection_info else 0 }}</h3>
                                <p class="text-muted">Total Connections</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-success">{{ connection_info[1] if connection_info else 0 }}</h3>
                                <p class="text-muted">Active Connections</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-warning">{{ connection_info[2] if connection_info else 0 }}</h3>
                                <p class="text-muted">Idle Connections</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Recent Activity (Last 24 Hours)</h5>
                </div>
                <div class="card-body">
                    {% if recent_activity %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Hour</th>
                                        <th>Transactions</th>
                                        <th>Activity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for activity in recent_activity %}
                                    <tr>
                                        <td>{{ activity[0].strftime('%Y-%m-%d %H:00') }}</td>
                                        <td>{{ activity[1] }}</td>
                                        <td>
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar bg-primary" 
                                                     style="width: {{ (activity[1] / recent_activity[0][1] * 100) if recent_activity[0][1] > 0 else 0 }}%">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No recent activity data available.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Auto-refresh script -->
<script>
let refreshInterval;

function refreshData() {
    fetch('/admin/database-monitor/api')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }
            
            // Update real-time data
            document.getElementById('db-size').textContent = data.db_size_pretty;
            document.getElementById('usage-percentage').textContent = data.usage_percentage + '%';
            document.getElementById('user-count').textContent = data.user_count;
            document.getElementById('connection-count').textContent = data.connection_count;
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = data.usage_percentage + '%';
            progressBar.textContent = data.usage_percentage + '%';
            progressBar.setAttribute('aria-valuenow', data.usage_percentage);
            
            // Update status color
            let statusClass = 'bg-success';
            if (data.usage_percentage >= 90) statusClass = 'bg-danger';
            else if (data.usage_percentage >= 75) statusClass = 'bg-warning';
            else if (data.usage_percentage >= 50) statusClass = 'bg-info';
            
            progressBar.className = 'progress-bar ' + statusClass;
            
            console.log('Database data refreshed at:', new Date().toLocaleTimeString());
        })
        .catch(error => {
            console.error('Error refreshing data:', error);
        });
}

// Auto-refresh every 30 seconds
function startAutoRefresh() {
    refreshInterval = setInterval(refreshData, 30000);
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
});

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});
</script>
{% endblock %}
